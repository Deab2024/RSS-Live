<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Läsare</title>
    <style>
        body {
            background-color: black; /* Svart bakgrund */
            color: white;           /* Vit text */
            font-family: Arial, sans-serif; /* Typsnitt Arial */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: flex-start; /* Placera innehåll i vänster kant */
            align-items: center;   /* Vertikal centrering */
            height: 100vh;
        }
        #rssFeed {
            max-width: 100%; /* Använd hela skärmbredden */
            padding-left: 20px; /* Minskad vänster-padding */
            line-height: 1.1; /* Kompakt radavstånd */
            box-sizing: border-box; /* Inkludera padding i bredd */
            text-align: left; /* Vänsterställ texten */
        }
        .event-title {
            font-size: 24px; /* Huvudtextstorlek */
            margin: 0;
            white-space: nowrap; /* Förhindra radbrytning */
            overflow: hidden; /* Dölja överskjutande text */
            text-overflow: ellipsis; /* "..." för text som inte ryms */
        }
        .event-location {
            font-size: 18px; /* Mindre textstorlek för platsen */
            margin: 5px 0 0;
            color: white; /* Vit text */
            white-space: nowrap; /* Förhindra radbrytning */
            overflow: hidden; /* Dölja överskjutande text */
            text-overflow: ellipsis; /* "..." för text som inte ryms */
        }
    </style>
</head>
<body>

<div id="rssFeed">
    <div id="eventTitle" class="event-title">Välkommen till Eskilstuna</div>
    <div id="eventLocation" class="event-location"></div>
</div>

<script>
    const rssUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e');

    let events = []; // Lagrar alla evenemang
    let currentEventIndex = 0; // Index för aktuellt evenemang
    let eventInterval; // Variabel för att lagra setInterval

    // Funktion för att extrahera datum från text
    function extractDateRange(title) {
        const datePattern = /\b(\d{1,2}\/\d{1,2})(\s?-\s?(\d{1,2}\/\d{1,2}))?\b/; // Matchar "5/2" eller "5/2 - 8/2"
        const match = title.match(datePattern);
        if (match) {
            const fullDate = match[0]; // Hela datumsträngen
            title = title.replace(fullDate, '').trim(); // Ta bort datumet från titeln
            return { date: fullDate, cleanedTitle: title };
        }
        return { date: '', cleanedTitle: title };
    }

    // Funktion för att hämta och visa RSS-flödet
    async function fetchRSS() {
        const rssFeed = document.getElementById("rssFeed");
        try {
            const response = await fetch(rssUrl);
            if (!response.ok) {
                resetToWelcomeMessage();
                return;
            }

            const data = await response.json();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(data.contents, "text/xml");

            const items = xmlDoc.getElementsByTagName("item");
            if (items.length === 0) {
                resetToWelcomeMessage();
                return;
            }

            // Spara titlar och platser för alla evenemang
            events = [];
            for (let i = 0; i < items.length; i++) {
                let title = items[i].getElementsByTagName("title")[0]?.textContent || 'Okänt evenemang';
                const location = items[i].getElementsByTagName("description")[0]?.textContent || 'Plats ej angiven';

                // Extrahera datum från titel
                const { date, cleanedTitle } = extractDateRange(title);

                const displayTitle = date ? `${date}, ${cleanedTitle}` : cleanedTitle;

                events.push({ title: displayTitle, location });
            }

            if (!eventInterval) {
                showNextEvent();
                eventInterval = setInterval(showNextEvent, 10000);
            }

        } catch (error) {
            resetToWelcomeMessage();
        }
    }

    // Funktion för att visa nästa evenemang
    function showNextEvent() {
        const eventTitle = document.getElementById("eventTitle");
        const eventLocation = document.getElementById("eventLocation");

        if (events.length > 0) {
            const currentEvent = events[currentEventIndex];
            eventTitle.textContent = currentEvent.title; // Titel med datum
            eventLocation.textContent = currentEvent.location; // Plats

            currentEventIndex = (currentEventIndex + 1) % events.length; // Gå till nästa, loopa om vid slut
        } else {
            resetToWelcomeMessage();
        }
    }

    // Funktion för att återgå till välkomstmeddelande
    function resetToWelcomeMessage() {
        document.getElementById("eventTitle").textContent = 'Välkommen till Eskilstuna';
        document.getElementById("eventLocation").textContent = '';
    }

    fetchRSS();
    setInterval(fetchRSS, 60000);
</script>

</body>
</html>
